<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel do Pastor — IQBJ (Editor avançado)</title>
<style>
  :root {
    --q-red: #c0392b;
    --q-yellow: #f6c85f;
    --q-blue: #2b6cb0;
    --q-purple: #7c3aed;
    --bg: linear-gradient(180deg,#051122,#08172a);
    --card: rgba(255,255,255,0.03);
    --muted: #bcd2ea;
    --small-muted: #9fb8d0;
  }

  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    font-family: "Inter", sans-serif;
    color: #eaf4ff;
  }

  /* Layout principal */
  .wrap {
    max-width: 1280px;
    margin: 0 auto;
    padding: 12px;
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 12px;
  }

  @media(max-width: 1100px){
    .wrap { grid-template-columns: 1fr; }
  }

  .card {
    background: var(--card);
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 12px 28px rgba(0,0,0,0.5);
  }

  h1 {
    margin: 0;
    margin-bottom: 4px;
    font-size: 26px;
    color: var(--q-yellow);
    text-shadow: 0 0 8px rgba(0,0,0,0.7);
  }

  label {
    display: block;
    font-weight: 600;
    margin: 6px 0 4px;
    color: #dce9f8;
  }

  input, textarea, select {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px;
    padding: 8px 10px;
    color: #eaf4ff;
    font-size: 15px;
  }
  textarea {
    resize: vertical;
    min-height: 60px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
  }
  .btn-primary {
    background: linear-gradient(90deg,var(--q-purple),var(--q-blue));
    color: #fff;
  }
  .btn-ghost {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.08);
    color: #cfe6ff;
  }

  .slides-list {
    margin-top: 14px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .slide-editor {
    padding: 12px;
    background: rgba(255,255,255,0.04);
    border-radius: 10px;
  }

  .slide-meta { margin-top: 8px }

  .slide-row {
    display: flex;
    gap: 8px;
    margin-top: 6px;
  }

  .small { font-size: 13px; color: var(--small-muted); }
  .preview {
    margin-top: 6px;
    background: rgba(255,255,255,0.04);
    padding: 12px;
    border-radius: 8px;
  }
  #previewStage {
    min-height: 130px;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding: 12px;
  }

  .theme-select {
    display:flex;
    gap:8px;
    margin-top:4px;
  }
</style>
</head>

<body>
<div class="wrap">
<main class="card">

<h1>Painel do Pastor — Editor Avançado</h1>
<div class="small">Crie slides poderosos com templates e estilos flexíveis.</div>

<div style="display:flex;gap:12px;margin-top:12px">
  <div style="flex:1">
    <label>Servidor HTTP</label>
    <input id="serverHttp" placeholder="Ex: http://192.168.0.120:3000"/>
  </div>
  <div style="width:180px">
    <label>Room</label>
    <input id="room" value="iqbj_sala1"/>
  </div>
</div>

<div style="margin-top:12px">
  <label>Título do Sermão</label>
  <input id="title" placeholder="Título do sermão / ministração">
</div>

<div style="margin-top:12px;display:flex;gap:10px;align-items:flex-end">
  <div style="flex:1">
    <label>Adicionar Slide</label>
    <select id="templateSelect">
      <option value="title">Título</option>
      <option value="bullet">Tópicos (bullets)</option>
      <option value="verse">Versículo</option>
      <option value="image">Imagem</option>
      <option value="quote">Citação</option>
      <option value="two">Duas Colunas</option>
      <option value="highlight">Caixa de destaque</option>
    </select>
  </div>
  <button id="addSlideBtn" class="btn btn-primary">Adicionar</button>
</div>

<div id="slidesList" class="slides-list"></div>

<div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
  <button class="btn btn-primary" id="saveBtn">Salvar no BD</button>
  <button class="btn btn-ghost" id="newBtn">Novo Sermão</button>
  <button class="btn btn-ghost" id="loadBtn">Carregar Sermões</button>
  <button class="btn btn-primary" id="sendBtn">Salvar & Enviar ao Telão</button>
</div>

<div style="display:flex;gap:10px;margin-top:10px;align-items:center">
  <button class="btn btn-primary" id="prevBtn">Anterior</button>
  <button class="btn btn-primary" id="nextBtn">Próximo</button>
  <span id="currentLabel" class="small">Slide: 0 / 0</span>
</div>

<section style="margin-top:14px">
  <strong style="color:var(--q-yellow)">Pré-visualização</strong>
  <div id="preview" class="preview">
    <div id="previewStage"></div>
  </div>
</section>

<section style="margin-top:14px">
  <strong style="color:var(--q-yellow)">Sermões Salvos</strong>
  <div id="sermonList" style="margin-top:8px"></div>
</section>

</main>

<aside class="card">
  <label>Conectar WebSocket</label>
  <div style="display:flex;gap:8px">
    <input id="wsUrl" placeholder="ws://192.168.0.120:3000"/>
    <button id="connectWS" class="btn btn-primary">Conectar</button>
  </div>
  <div id="status" class="small" style="margin-top:8px">Desconectado</div>

  <div style="margin-top:14px">
    <label>Temas rápidos</label>
    <div class="theme-select">
      <button class="btn btn-ghost" data-theme="quadrangular">Quadrangular</button>
      <button class="btn btn-ghost" data-theme="dark">Escuro</button>
      <button class="btn btn-ghost" data-theme="light">Claro</button>
    </div>
  </div>

  <div class="small" style="margin-top:14px">
    Abra no PC:<br/>
    <code>http://IP:3000/tela.html?room=iqbj_sala1</code><br/><br/>
    No painel, coloque o WS e clique conectar.
  </div>
</aside>
</div>
<script>
/* ============================================================
   AUTO-LAYOUT (ADICIONADO)
   Ajusta fonte, espaçamento e organização do slide conforme o conteúdo.
   NÃO altera cores automaticamente.
=============================================================== */
function autoLayout(slide){
  if(!slide || !slide.data) return slide;

  const st = slide.style || {};
  const type = slide.type;

  // Valores padrão
  st.fontSize = st.fontSize || '28px';
  st.lineHeight = st.lineHeight || '1.25';
  st.padding = st.padding || '14px';

  // TÍTULO
  if(type === "title"){
    const len = (slide.data.content || "").length;
    if(len < 20)      st.fontSize = "44px";
    else if(len < 40) st.fontSize = "36px";
    else              st.fontSize = "30px";
  }

  // BULLETS
  if(type === "bullet"){
    const qtd = slide.data.lines.length;
    if(qtd <= 3)      st.fontSize = "30px";
    else if(qtd <= 6) st.fontSize = "24px";
    else              st.fontSize = "20px";
  }

  // VERSÍCULO
  if(type === "verse"){
    const len = (slide.data.verseText || "").length;
    if(len <= 120)      st.fontSize = "32px";
    else if(len <= 250) st.fontSize = "26px";
    else                st.fontSize = "22px";
  }

  // CITAÇÃO
  if(type === "quote"){
    const len = (slide.data.content || "").length;
    if(len <= 100)      st.fontSize = "30px";
    else if(len <= 200) st.fontSize = "24px";
    else                st.fontSize = "20px";
  }

  // DUAS COLUNAS
  if(type === "two"){
    const L = (slide.data.left || "").length;
    const R = (slide.data.right || "").length;
    const big = Math.max(L, R);
    if(big <= 140)      st.fontSize = "24px";
    else                st.fontSize = "20px";
  }

  // CAIXA DE DESTAQUE
  if(type === "highlight"){
    st.fontSize = "28px";
  }

  slide.style = st;
  return slide;
}
/* ============================================================
   FIM DO AUTO-LAYOUT
=============================================================== */


/* ============================================================
   VARIÁVEIS PRINCIPAIS
=============================================================== */
let slides = [];
let currentIndex = 0;
let ws = null;

const slidesList = document.getElementById('slidesList');
const previewStage = document.getElementById("previewStage");
const statusEl = document.getElementById("status");

/* ============================================================
   FUNÇÃO: RENDERIZAR LISTA DE SLIDES
=============================================================== */
function renderSlides(){
  slidesList.innerHTML = "";
  slides.forEach((sl, i) => {
    const item = document.createElement("div");
    item.className = "slide-editor";

    let html = "";

    if(sl.type === "title"){
      html = `
        <label>Título</label>
        <input value="${sl.data.content}" data-field="content" data-i="${i}"/>
      `;
    }
    else if(sl.type === "bullet"){
      html = `
        <label>Bullets</label>
        <textarea data-field="lines" data-i="${i}">${sl.data.lines.join("\n")}</textarea>
      `;
    }
    else if(sl.type === "verse"){
      html = `
        <label>Livro / Referência</label>
        <input value="${sl.data.book}" data-field="book" data-i="${i}"/>
        <label>Texto do versículo</label>
        <textarea data-field="verseText" data-i="${i}">${sl.data.verseText}</textarea>
      `;
    }
    else if(sl.type === "image"){
      html = `
        <label>URL da imagem</label>
        <input value="${sl.data.url}" data-field="url" data-i="${i}"/>
      `;
    }
    else if(sl.type === "quote"){
      html = `
        <label>Citação</label>
        <textarea data-field="content" data-i="${i}">${sl.data.content}</textarea>
        <label>Autor</label>
        <input value="${sl.data.author}" data-field="author" data-i="${i}"/>
      `;
    }
    else if(sl.type === "two"){
      html = `
        <label>Coluna Esquerda</label>
        <textarea data-field="left" data-i="${i}">${sl.data.left}</textarea>
        <label>Coluna Direita</label>
        <textarea data-field="right" data-i="${i}">${sl.data.right}</textarea>
      `;
    }
    else if(sl.type === "highlight"){
      html = `
        <label>Texto de destaque</label>
        <textarea data-field="content" data-i="${i}">${sl.data.content}</textarea>
      `;
    }

    item.innerHTML = html + `
      <div class="slide-row">
        <button class="btn btn-ghost" onclick="deleteSlide(${i})">Excluir</button>
        <button class="btn btn-ghost" onclick="moveUp(${i})">↑</button>
        <button class="btn btn-ghost" onclick="moveDown(${i})">↓</button>
      </div>
    `;

    slidesList.appendChild(item);
  });
}

/* ============================================================
   ATUALIZA CAMPOS DOS SLIDES
=============================================================== */
slidesList.addEventListener("input", (e) => {
  const field = e.target.dataset.field;
  const i = parseInt(e.target.dataset.i);

  if(field === "lines"){
    slides[i].data.lines = e.target.value.split("\n").filter(Boolean);
  }
  else{
    slides[i].data[field] = e.target.value;
  }

  renderPreview();
});

/* ============================================================
   FUNÇÕES DE ORGANIZAÇÃO DE SLIDES
=============================================================== */
function deleteSlide(i){
  slides.splice(i,1);
  if(currentIndex >= slides.length) currentIndex = slides.length - 1;
  if(currentIndex < 0) currentIndex = 0;
  renderSlides();
  renderPreview();
}

function moveUp(i){
  if(i === 0) return;
  [slides[i], slides[i-1]] = [slides[i-1], slides[i]];
  currentIndex = i - 1;
  renderSlides();
  renderPreview();
}

function moveDown(i){
  if(i === slides.length - 1) return;
  [slides[i], slides[i+1]] = [slides[i+1], slides[i]];
  currentIndex = i + 1;
  renderSlides();
  renderPreview();
}

/* ============================================================
   FUNÇÃO DE PRÉ-VISUALIZAÇÃO (MODIFICADA PARA AUTO-LAYOUT)
=============================================================== */
function renderPreview(){
  previewStage.innerHTML = "";

  if(slides.length === 0){
    previewStage.innerHTML = "<div class='small'>Nenhum slide</div>";
    return;
  }

  // AUTO-LAYOUT AQUI
  const raw = slides[currentIndex];
  const s = autoLayout(JSON.parse(JSON.stringify(raw)));

  const box = document.createElement("div");
  box.style.width = "100%";
  box.style.padding = s.style.padding;
  box.style.fontSize = s.style.fontSize;
  box.style.lineHeight = s.style.lineHeight;

  if(s.type === "title"){
    box.innerHTML = `<h2 style="margin:0;font-size:${s.style.fontSize}">${s.data.content}</h2>`;
  }

  else if(s.type === "bullet"){
    const ul = document.createElement("ul");
    ul.style.fontSize = s.style.fontSize;
    ul.style.textAlign = "left";
    s.data.lines.forEach(l => {
      const li = document.createElement("li");
      li.innerText = l;
      ul.appendChild(li);
    });
    box.appendChild(ul);
  }

  else if(s.type === "verse"){
    box.innerHTML = `
      <div style="font-size:${s.style.fontSize}">${s.data.verseText}</div>
      <div style="margin-top:6px;font-size:14px;opacity:0.7">${s.data.book}</div>
    `;
  }

  else if(s.type === "image"){
    box.innerHTML = `<img src="${s.data.url}" style="max-width:100%;border-radius:8px">`;
  }

  else if(s.type === "quote"){
    box.innerHTML = `
      <div style="font-size:${s.style.fontSize}">"${s.data.content}"</div>
      <div style="margin-top:6px;font-size:14px;opacity:0.7">— ${s.data.author}</div>
    `;
  }

  else if(s.type === "two"){
    box.innerHTML = `
      <div style="display:flex;gap:20px;justify-content:center;text-align:left">
        <div style="flex:1;font-size:${s.style.fontSize}">${s.data.left.replace(/\n/g,"<br>")}</div>
        <div style="flex:1;font-size:${s.style.fontSize}">${s.data.right.replace(/\n/g,"<br>")}</div>
      </div>
    `;
  }

  else if(s.type === "highlight"){
    box.innerHTML = `
      <div style="padding:20px;border-radius:8px;background:rgba(255,255,255,0.08);font-size:${s.style.fontSize}">
        ${s.data.content}
      </div>
    `;
  }

  previewStage.appendChild(box);
  document.getElementById("currentLabel").innerText =
    `Slide: ${currentIndex+1} / ${slides.length}`;
}
/* ============================================================
   BOTÕES DE NAVEGAÇÃO (APLICAM AUTO-LAYOUT NA PRÉ-VISUALIZAÇÃO)
=============================================================== */
document.getElementById("prevBtn").addEventListener("click", () => {
  if(currentIndex > 0) currentIndex--;
  renderPreview();
});

document.getElementById("nextBtn").addEventListener("click", () => {
  if(currentIndex < slides.length - 1) currentIndex++;
  renderPreview();
});

/* ============================================================
   ADICIONAR NOVO SLIDE
=============================================================== */
document.getElementById("addSlideBtn").addEventListener("click", () => {
  const type = document.getElementById("templateSelect").value;

  const s = {
    type,
    data:{},
    style:{}
  };

  if(type === "title"){
    s.data.content = "";
  }
  if(type === "bullet"){
    s.data.lines = [];
  }
  if(type === "verse"){
    s.data.book = "";
    s.data.verseText = "";
  }
  if(type === "image"){
    s.data.url = "";
  }
  if(type === "quote"){
    s.data.content = "";
    s.data.author = "";
  }
  if(type === "two"){
    s.data.left = "";
    s.data.right = "";
  }
  if(type === "highlight"){
    s.data.content = "";
  }

  slides.push(s);
  currentIndex = slides.length - 1;

  renderSlides();
  renderPreview();
});

/* ============================================================
   SALVAR SERMÃO
=============================================================== */
document.getElementById("saveBtn").addEventListener("click", async () => {
  const title = document.getElementById("title").value.trim();
  if(!title){
    alert("Digite o título do sermão");
    return;
  }

  const payload = {
    title,
    slides,
    date: new Date().toISOString()
  };

  try{
    const base = baseUrl();
    const res = await fetch(base + "/api/sermons", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok) throw new Error("Erro ao salvar");

    alert("Sermão salvo com sucesso!");
    loadSermons();

  }catch(e){
    alert("Erro: " + e.message);
  }
});

/* ============================================================
   CARREGAR LISTA DE SERMÕES
=============================================================== */
document.getElementById("loadBtn").addEventListener("click", loadSermons);

async function loadSermons(){
  try{
    const base = baseUrl();
    const res = await fetch(base + "/api/sermons");
    if(!res.ok) throw new Error("Erro ao carregar");
    const list = await res.json();
    renderSermonList(list);
  }catch(e){
    alert("Erro: " + e.message);
  }
}

/* Construção da lista na interface */
function renderSermonList(list){
  const box = document.getElementById("sermonList");
  box.innerHTML = "";

  if(list.length === 0){
    box.innerHTML = "<div class='small'>Nenhum sermão salvo</div>";
    return;
  }

  list.forEach(s => {
    const row = document.createElement("div");
    row.style.padding = "8px";
    row.style.border = "1px solid rgba(255,255,255,0.05)";
    row.style.marginBottom = "6px";
    row.style.borderRadius = "8px";

    row.innerHTML = `
      <div style="font-weight:800;color:var(--q-yellow)">${s.title}</div>
      <div class="small">${s.date}</div>

      <button class="btn btn-ghost" onclick="loadSermon('${s.id}')">Carregar</button>
      <button class="btn btn-primary" onclick="sendSermonToDisplay('${s.id}')">Enviar ao Telão</button>
      <button class="btn" style="color:#ffb4b4" onclick="deleteSermon('${s.id}')">Excluir</button>
    `;

    box.appendChild(row);
  });
}

/* ============================================================
   CARREGAR SERMÃO COMPLETO
=============================================================== */
async function loadSermon(id){
  try{
    const base = baseUrl();
    const res = await fetch(base + "/api/sermons/" + id);
    if(!res.ok) throw new Error("Não encontrado");

    const sermon = await res.json();

    document.getElementById("title").value = sermon.title;
    slides = sermon.slides;
    currentIndex = 0;

    renderSlides();
    renderPreview();

  }catch(e){
    alert("Erro: " + e.message);
  }
}

/* ============================================================
   EXCLUIR SERMÃO
=============================================================== */
async function deleteSermon(id){
  if(!confirm("Excluir este sermão?")) return;

  try{
    const base = baseUrl();
    const res = await fetch(base + "/api/sermons/" + id, { method:"DELETE" });
    if(!res.ok) throw new Error("Erro ao excluir");

    loadSermons();

  }catch(e){
    alert("Erro: " + e.message);
  }
}

/* ============================================================
   ENVIAR AO TELÃO (APLICA AUTO-LAYOUT ANTES DE ENVIAR)
=============================================================== */
async function sendSermonToDisplay(id){
  try{
    const base = baseUrl();
    const res = await fetch(base + "/api/sermons/" + id);
    if(!res.ok) throw new Error("Não encontrado");

    const sermon = await res.json();

    // AUTO-LAYOUT EM TODOS OS SLIDES
    sermon.slides = sermon.slides.map(s => autoLayout(s));

    if(ws && ws.readyState === WebSocket.OPEN){
      ws.send(JSON.stringify({
        type:"load",
        room: roomEl.value.trim(),
        sermon
      }));

      alert("Sermão enviado ao telão!");
    }else{
      alert("WebSocket não conectado");
    }

  }catch(e){
    alert("Erro: " + e.message);
  }
}

/* ============================================================
   CONECTAR AO WEBSOCKET
=============================================================== */
document.getElementById("connectWS").addEventListener("click", () => {
  const url = wsUrlEl.value.trim();
  if(!url) return alert("Informe o endereço WS.");

  try{
    ws = new WebSocket(url);

    ws.addEventListener("open", () => {
      statusEl.textContent = "Conectado";
      ws.send(JSON.stringify({
        type:"hello",
        role:"panel",
        room: roomEl.value.trim()
      }));
    });

    ws.addEventListener("close", () => statusEl.textContent = "Desconectado");
    ws.addEventListener("error", () => statusEl.textContent = "Erro");

  }catch(e){
    alert("Falha ao conectar: " + e.message);
  }
});

/* ============================================================
   NAVEGAÇÃO DO TELÃO VIA TECLAS
=============================================================== */
document.addEventListener("keydown", (e) => {
  if(e.key === "ArrowRight"){
    document.getElementById("nextBtn").click();
    gotoIndex(currentIndex);
  }
  if(e.key === "ArrowLeft"){
    document.getElementById("prevBtn").click();
    gotoIndex(currentIndex);
  }
});

/* Enviar mudança de slide ao telão */
function gotoIndex(i){
  if(i < 0) i = 0;
  if(i > slides.length - 1) i = slides.length - 1;
  currentIndex = i;

  if(ws && ws.readyState === WebSocket.OPEN){
    ws.send(JSON.stringify({
      type:"goto",
      room: roomEl.value.trim(),
      index: i
    }));
  }

  renderPreview();
}

/* ============================================================
   INICIALIZAÇÃO
=============================================================== */
renderSlides();
renderPreview();
loadSermons();

</script>
</body>
</html>
